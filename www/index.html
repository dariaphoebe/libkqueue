<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Language" content="en-us" />

    <title>libkqueue</title>
    <style type="text/css">
    body {
        margin-left: 2em;
        padding-bottom: 2em;
    }
    .blockquote { margin-right: 2em }
    code.block { 
         padding: 20px; 
         border: 1px solid black; 
         background: beige;
         margin: 3em; 
    }
    h1 {
        margin-left: -0.5em;
    }
    h2 {
        margin-left: -0.5em;
        padding-top: 1em;
    }
    ol {
        margin: 2em;
    }
    li {
        padding-bottom: 10px;
    }
    p {
        padding-bottom: 10px;
    } 
    </style>
</head>

<body>

<h1>libkqueue</h1>

libkqueue is a portable userspace implementation of the <a href="http://www.freebsd.org/cgi/man.cgi?query=kqueue&sektion=2">kqueue(2)</a> kernel event notification mechanism. Initial efforts are focused on porting the kqueue API to the Linux 2.6 kernel.

<h2>Download</h2>

Source code releases can be found <a href="dist">here</a>. There are no binary packages at the moment.
<p>
To checkout the entire SVN repository, run the following command:
<p>
<code class=block>svn co svn://mark.heily.com/libkqueue</code>
<p>
You can checkout the trunk by using the following command:
<p>
<code class=block>svn co svn://mark.heily.com/libkqueue/trunk libkqueue</code>

<p>
There is heavy development on the trunk, and it may not always be in a usable state. If you want to be current, but not bleeding edge, there is also a stable branch. You can checkout the stable branch by using the following command:
<p>
<code class=block>svn co svn://mark.heily.com/libkqueue/branches/stable libkqueue</code>
   

<h2>Mailing Lists</h2>

There are two mailing lists: one for general discussion, and one for announcements.  If you subscribe to a mailing list through the web interface, you will need to sign up for a free Google account. If you prefer not to create a Google account, you can subscribe via email instead.
<p>
To subscribe to the general discussion group, visit the group's <a href="http://groups.google.com/group/libkqueue">web interface</a>, or send an email to <a href="mailto:libkqueue+subscribe@googlegroups.com">libkqueue+subscribe@googlegroups.com</a>. 
<p>
To subscribe to the low-traffic annoucements-only group, visit the group's <a href="http://groups.google.com/group/libkqueue-announce">web interface</a>, or send an email to <a href="mailto:libkqueue-announce+subscribe@googlegroups.com">libkqueue-announce+subscribe@googlegroups.com</a>. 
<p>
Please note that if you use multiple email addresses, Google Groups does not allow you to choose which email address will receive messages. The address on the <code>From:</code> line of the subscribe request will be used as the destination address.
<p>
To unsubscribe from either group, send an email to <code>[group name]+unsubscribe@googlegroups.com</code>. If you have any problems subscribing or unsubscribing, send a note to <a href="mailto:devel+libkqueue@heily.com">Mark Heily</a>.

<h2>Status</h2>

The kqueue and kevent functions are implemented, and most of the filters are working. The following filters are not yet implemented:<p>

<ul>
 <li><code>EVFILT_PROC</code>
 <li><code>EVFILT_AIO</code>
 <li><code>EVFILT_FS</code>
 <li><code>EVFILT_NETDEV</code>
</ul>

More details about the current implementation status can be found <a href="status.html">here</a>.
<p>
There are several compatibility issues to be aware of when using this library under Linux:<br>

<ol>

<li>The NOTE_LOWAT flag is not supported. According to <i>socket(7)</i>,<br>
<pre style="blockquote">
"The select(2) and poll(2) system  calls  currently  do not respect the 
SO_RCVLOWAT setting on Linux, and mark a socket readable when even  a  
single  byte  of data is available.  A subsequent read from the socket 
will block until SO_RCVLOWAT bytes are available."</pre>
</li>

<li>
The NOTE_REVOKE flag is not supported because Linux does not have
a <code>revoke(2)</code> system call.
</li>

<li>
When an EVFILT_SIGNAL event is generated, the <code>data</code> field 
is set to 1 regardless of how many times the signal was received by the process.
</li>

<!--
<li>
The EVFILT_PROC filter only supports the NOTE_EXIT flag, and the <code>ident</code> field must contain the PID of a child of the current process. This filter is only suitable as an event-driven replacement for the <code>wait(2)</code> family of system calls.
</li>
-->

</ol>

<h2>Future Plans</h2>

In the future, I plan to add three more backends. One will be for Solaris and take advantage of the event port mechanism described in <a href="http://docs.sun.com/app/docs/doc/816-5168/port-create-3c?l=en&a=view&q=port_create">port_create(3C)</a>. The second will be a generic POSIX backend that does not use any non-portable system calls. The third will be a Microsoft Windows port that uses <code>WaitForMultipleObjects()</code>.

<h2>Portability of kevent(2) across BSD systems</h2>

There are some differences in the behavior of the <code>kevent(2)</code> system call across the various BSD-based operating systems. Here are some of the differences to be aware of:

<ol>

<li>FreeBSD 8 does not set the <i>EV_ADD</i> flag for kevents on the eventlist, but OpenBSD and Darwin do. This means you should never use the equality operator (==) to test the flags; use the logical AND operator instead.
</li>

<li>The <code>EVFILT_USER</code> filter behaves differently from other filters with respect to the <i>EV_ONESHOT</i> flag. All other filters will preserve the flag when the event is triggered and placed on the eventlist. The <code>EVFILT_USER</code> filter does not preserve this flag.
</li>

<li>
OpenBSD has the <i>NOTE_TRUNCATE</i> fflag, while FreeBSD and Darwin do not.
</li>

<li>
EVFILT_FS is undocumented and only available on FreeBSD and Darwin. Here is the <a href="http://adam.kungfoohampster.com/lists/cvs-all/msg71399.shtml">CVS commit log</a> which could be helpful to document this filter.
</li>
<!--
<li>
[TODO - Verify and check against 10.6] OS X 10.5 and earlier do not implement the <code>EVFILT_AIO</code> or <code>EVFILT_TIMER</code> filters.
</li>
-->

</ol>


<h2>Requirements</h2>

libkqueue currently requires the following:

<ul>
<li>GCC
<li>Linux 2.6.22 or higher
<li>glibc 2.8 or higher
</ul>

<h2>Usage</h2>

Here are the steps to use libkqueue in your program:
<ol>
<li>Add <code>`pkg-config libkqueue --cflags`</code> to the CFLAGS variable.
<li>Add <code>`pkg-config libkqueue --libs`</code> to the LDADD variable.
<li>Add <code>#include &lt;sys/event.h&gt;</code> to the source code.
</ol>

<h3>Threads</h3>

libkqueue uses one or more helper threads, so all programs that link with libkqueue must also link against the pthreads library. Calls to <code>kqueue()</code> and <code>kevent()</code> are safe to be used from multiple threads.

<h2>Links</h2>

<ul>

<li>
 <a href="http://people.freebsd.org/~jlemon/papers/kqueue.pdf">Kqueue: A generic and scalable event notification facility</a> [Lemon][PDF]
</li>

<li><a href="http://doc.geoffgarside.co.uk/kqueue/">Kqueues for Fun and Profit</a> [Werner]</li>
</ul>

<li>
<a href="http://www.opensource.apple.com/source/xnu/xnu-1456.1.26/tools/tests/xnu_quick_test/kqueue_tests.c">XNU kqueue test program</a> - Demonstrates use of EVFILT_USER
</li>

<h3>Solaris Event Ports</h3>
I do plan to add Solaris event port support to libkqueue once the Linux backend is complete and the internal API is stabilized. I checked the port_create(3C) manpage in Solaris 10 and OpenSolaris, and did not see any way to wait for signals. There is also no equivalent to EVFILT_VNODE in Solaris 10, although OpenSolaris has the PORT_SOURCE_FILE functionality.
<ul>
<li>
<a href="http://docs.sun.com/app/docs/doc/816-5168/port-create-3c?l=en&a=view&q=port_create">Solaris 10 port_create(3C) manual page</a>
</li>

<li>
<a href="http://docs.sun.com/app/docs/doc/819-2243/port-create-3c?a=view">
OpenSolaris port_create(3C) manual page</a>
</li>


<h2>Contact</h2>
For more information, contact <a href="mailto:devel+libkqueue@heily.com">Mark Heily</a>.

<p>
<hr>
<center>
&copy; 2009 Mark Heily. All rights reserved.
</center>

</body>
</html>
